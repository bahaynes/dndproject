<<<<<<< HEAD
<<<<<<< HEAD
<<<<<<< HEAD
# Stage 1: Build Caddy with Cloudflare plugin
FROM public.ecr.aws/docker/library/caddy:2-builder AS caddy_builder
RUN xcaddy build \
    --with github.com/caddy-dns/cloudflare

# Base stage for installing dependencies
FROM public.ecr.aws/docker/library/node:20-alpine AS base
WORKDIR /app
RUN npm install -g pnpm
COPY frontend/package.json frontend/pnpm-lock.yaml* frontend/svelte.config.js frontend/vite.config.ts frontend/tsconfig.json ./
RUN pnpm install

# Dev stage
FROM base AS dev
COPY frontend/ .
EXPOSE 5173
CMD ["pnpm", "dev", "--host", "0.0.0.0", "--port", "5173"]

# Build stage for production
FROM base AS build
COPY frontend/ .
RUN pnpm build

# Production stage to serve with Caddy
FROM public.ecr.aws/docker/library/caddy:2-alpine AS prod
COPY --from=caddy_builder /usr/bin/caddy /usr/bin/caddy
WORKDIR /srv
COPY --from=build /app/build /srv
COPY frontend/Caddyfile /etc/caddy/Caddyfile
=======
=======
>>>>>>> origin/main
=======
>>>>>>> 2021aa48142f2fd37e4cd82ec5e48b5b8e7499f3
# Stage 1: Build & Test (Node environment)
FROM node:20-alpine AS builder
WORKDIR /app

# Install pnpm
RUN npm install -g pnpm
COPY frontend/package.json frontend/pnpm-lock.yaml* ./
RUN pnpm install
COPY frontend/ .
RUN pnpm build

# Copy the rest of the frontend code
COPY frontend/ .

# Stage 1a: Optional test stage
FROM builder AS test
# Run frontend tests inside the container
# Exits with error code if tests fail
CMD ["pnpm", "test", "--", "--watch=false"]

# Stage 2: Production image (Caddy only)
FROM caddy:2-alpine AS production
WORKDIR /srv

# Copy built static files from builder
COPY --from=builder /app/build /srv

# Copy Caddy config
COPY frontend/Caddyfile /etc/caddy/Caddyfile

<<<<<<< HEAD
<<<<<<< HEAD
>>>>>>> origin/main
=======
>>>>>>> origin/main
=======
>>>>>>> 2021aa48142f2fd37e4cd82ec5e48b5b8e7499f3
EXPOSE 80 443
CMD ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--adapter", "caddyfile"]
