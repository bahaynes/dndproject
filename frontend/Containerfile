# Stage 1: Build Caddy with Cloudflare plugin
FROM public.ecr.aws/docker/library/caddy:2-builder AS caddy_builder
RUN xcaddy build \
    --with github.com/caddy-dns/cloudflare

# Base stage for installing dependencies
FROM public.ecr.aws/docker/library/node:20-alpine AS base
WORKDIR /app
RUN npm install -g pnpm
COPY frontend/package.json frontend/pnpm-lock.yaml* frontend/svelte.config.js frontend/vite.config.ts frontend/tsconfig.json ./
RUN pnpm install

# Dev stage
FROM base AS dev
COPY frontend/ .
EXPOSE 5173
CMD ["pnpm", "dev", "--host", "0.0.0.0", "--port", "5173"]

# Build stage for production
FROM base AS build
COPY frontend/ .
RUN pnpm build

# Production stage to serve with Caddy
FROM public.ecr.aws/docker/library/caddy:2-alpine AS prod
COPY --from=caddy_builder /usr/bin/caddy /usr/bin/caddy
WORKDIR /srv
COPY --from=build /app/build /srv
COPY frontend/Caddyfile /etc/caddy/Caddyfile
EXPOSE 80 443
CMD ["caddy", "run", "--config", "/etc/caddy/Caddyfile", "--adapter", "caddyfile"]
