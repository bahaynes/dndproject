name: Cleanup Preview

on:
  pull_request:
    types: [closed]

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Cleanup Preview Environment
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_KEY }}
          script: |
            PR_NUM=${{ github.event.number }}
            DIR=~/deploy/pr-${PR_NUM}
            if [ -d "$DIR" ]; then
              echo "Cleaning up $DIR..."
              cd $DIR

              # Export dummy variables to satisfy docker-compose config validation if strictly needed
              # (though we use defaults for most)
              export DOMAIN_NAME=cleanup
              export CLOUDFLARE_API_TOKEN=cleanup

              docker compose down --volumes --remove-orphans
              cd ..
              rm -rf pr-${PR_NUM}
              echo "Cleanup complete."
            else
              echo "Directory $DIR does not exist. Nothing to clean up."
            fi
